name: Open PR for feature branch

on:
  push:
    branches:
      - feature/srs-pricing-payment

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create or update PR
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const head = `${owner}:feature/srs-pricing-payment`;
            const base = 'main';
            const title = 'feat: SRS-driven quoting, payment checkout, and documentation suite';
            const body = `
            **Summary**
            Introduces SRS-driven quoting workflow and a comprehensive payment section. Adds documentation covering pricing, self-service, automation, testimonials, portfolio, version control, rollback, and docs process.

            **Changes**
            - Pages: QuotePage (SRS workflow), Payment (checkout), Onboarding
            - Components: SRSQuoteForm, SRSQuoteSummary; legacy QuoteSummary redirect updated
            - Library: srs.ts (analysis + tiered pricing), pricing.ts (legacy), pdf.ts
            - Styles/Config: index.css import fix; tailwind.config.ts plugin import (ESM)

            **Payment Highlights**
            - Method selection: Card, PayPal, Bank Transfer
            - Secure card validation (Luhn, expiry, CVV) and accessible messages
            - Billing info collection and order summary with deposit/full and coupons
            - Terms checkbox required; `Intl.NumberFormat` currency (USD/EUR/GBP)

            **Compliance & Accessibility**
            - PCI-aligned UI (no card storage; ready for provider tokenization)
            - WCAG 2.1 attributes and keyboard-friendly controls

            **Testing Checklist**
            - Quote → Summary → Payment → Onboarding
            - SRS indicators coverage; card validation; coupons; no-order cases
            - Build performance verified and local preview successful

            **Risks & Backout**
            - Payment UI simulates status; needs provider integration for charges
            - Redirects to /payment; backout plan: restore /onboarding redirect and remove Payment page
            `;

            const existing = await github.rest.pulls.list({ owner, repo, head, base, state: 'open' });
            if (existing.data.length) {
              core.info('PR already exists: ' + existing.data[0].html_url);
            } else {
              const pr = await github.rest.pulls.create({ owner, repo, title, body, head, base });
              core.info('PR created: ' + pr.data.html_url);
            }
